# 7. 병렬 데이터 처리와 성능

## 병렬 스트림

- 컬렉션에 parallelStraem을 호출하면 병렬 스트림이 생성.
- 병렬 스트림이란 각각의 스레드에서 처리할 수 있도록 스트림 요소를 여러 청크로 분할한 스트림

### 병렬 스트림에서 사용하는 스레드 풀 설정

- 병렬 스트림은 내부적으로 ForkJoinPool을 사용한다.
- 기본적으로 ForkJoinPool은 프로세서 수에 상응하는 스레드를 갖는다.

### 병렬 스트림 주의사항

- 병렬화를 이용하면 스트림을 재귀적으로 분할해야 하고, 각 서브스트림을 서로 다른 스레드의 리듀싱 연산으로 할당하고, 이들 결과를 하나의 값으로 합쳐야 한다. 멀티 코어 간의 데이터 이동은 생각보다 비쌈.
- 병렬 스트림과 병렬 계산에서는 공유된 가변 상태를 피해야 한다.

```java
    public static void main(String[]args){
		long result=sideEffectSum(10_000_000L); // 올바른 값이 나오지 않음 (50000005000000X)
		System.out.println(result);
		}

private static long sideEffectSum(long n){
		Accumulator accumulator=new Accumulator();
		LongStream.rangeClosed(1,n)
		.parallel()
		.forEach(accumulator::add); // 여러 스레드에서 동시에 누적자, (total += value)를 실행하면서 이러한 문제가 발생.
		return accumulator.total;
		}

private static class Accumulator {
	public long total = 0; // total에 접근할 때 마다 (다수의 스레드에서 동시에 데이터에 접근하는) 데이터 레이스 문제가 발생한다.

	public void add(long value) {
		total += value;
	}
}
```

### 병렬 스트림 효과적으로 사용하기

- 순차 스트림과 병렬 스트림 중 어떤 것이 좋을지 모르겠다면 적절한 벤치마크로 직접 성능을 측정하는 것이 바람직하다.
- 박싱을 주의하라. 자동 방식과 언박싱은 성능을 크게 저하시킬 수 있는 요소. (기본형 특화 스트림을 사용하는 것이 좋음: IntStream...)
- 순차 스트림보다 병렬 스트림에서 성능이 떨어지는 연산이 있다. 특히 limit나 findFirst처럼 요소의 순서에 의존하는 연산을 병렬 스트림에서 수행하려면 비싼 비용을 치러야 한다.
- 스트림에서 수행하는 전체 파이프라인 연산 비용을 고려하라
- 소량이 데이터에서는 병렬 스트림이 도움 되지 않는다.
- 스트림을 구성하는 자료구조가 적절한지 확인하라.
- 스트림의 특성과 파이프라인의 중간 연산이 스트림의 특성을 어떻게 바꾸는지에 따라 분해 과정의 성능이 달라질 수 있다.
- 최종 연산의 병합 과정 비용을 살펴보라. 병합 과정의 비용이 비싸다면 병렬 스트림으로 얻은 성능의 이익이 서브스트림의 부분 결과를 합치는 과정에서 상쇄될 수 있다.

## 포크/조인 프레임워크

- 병렬화할 수 있는 작업을 재귀적으로 작은 작업으로 분할한 다음에 서브태스크 각각의 결과를 합쳐서 전체 결과를 만들도록 설계
- 분할 정복 알고리즘

### 포크/조인 프레임워크를 제대로 사용하는 방법

- join 메소드를 테스크에 호출하면 테스크가 생산하는 결과가 준비될 때 까지 호출자를 블록시킨다.

- 따라서 두 서브태스크가 모두 시작된 다음에 join을 호출해야 한다. 그렇지 않으면 각가의 서브태스크가 다른 태스크가 끝나길 기다리는 일이 발생하며 원래 순차 알고리즘 보다 느리고 복잡한 프로그램이 되어 버릴 수
  있다.

### 정리

- 내부 반복을 이용하면 명시적으로 다른 스레드를 사용하지 않고도 스트림을 병렬로 처리할 수 있다.
- 간단하게 스트림을 병렬로 처리할 수 있지만, 항상 병렬 처리가 빠른 것은 아니다. 성능을 직접 측정해봐야 한다.
- 병렬 스트림으로 데이터 집합을 병렬 실행할 때 특히 처리해야 할 데이터가 아주 많거나 각 요소를 처리하는 데 오랜 시간이 걸릴 떄 성능을 높일 수 있다.
- 가능하면 기본형 특화 스트림을 사용하는 등 올바른 자료구조 선택이 어떤 연산을 병렬로 처리하는 것보다 성능적으로 더 큰 영향을 미칠 수 있다.
- 포크/조인 프레임워크에서는 병렬화할 수 있는 테스크를 작은 테스크로 분할한 다음에 분할된 테스크를 각각의 스레드로 실행하며 서브태스크 각각의 결과를 합쳐서 최종 결과를 생산한다.
- Spliterator는 탐색하려는 데이터를 포함하는 스트림을 어떻게 병렬화할 것인지 정의한다.